ğŸ“© PROMPT FÃœR REPLIT (KOPIEREN & SENDEN)

Titel: Kritischer Architektur-Bug: Neon wird bei jedem Pull wieder aktiviert â€“ dauerhafte LÃ¶sung nÃ¶tig

Hallo,

wir haben einen kritischen Architekturfehler im aktuellen Setup identifiziert, der bei jedem git pull auf einem externen Server (VPS) die Anwendung bricht.

ğŸ”´ Das Problem

Die App wurde ursprÃ¼nglich fÃ¼r Replit/Neon entwickelt und nutzt in mehreren Dateien:

@neondatabase/serverless

drizzle-orm/neon-http

Sobald auf dem externen Server ein

git pull origin main


ausgefÃ¼hrt wird, kommen diese Neon-Imports automatisch zurÃ¼ck, obwohl der Server:

lokales PostgreSQL nutzt

keine Neon-HTTP-Verbindung haben darf

keinen TLS-Bypass (NODE_TLS_REJECT_UNAUTHORIZED=0) braucht

Das fÃ¼hrt reproduzierbar zu folgenden Fehlern:

SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
at @neondatabase/serverless


und auÃŸerdem zu:

FAILED: OneSignal not configured


(obwohl die ENV korrekt gesetzt ist â€“ sie wird nur nie erreicht, weil der falsche DB-Adapter lÃ¤uft).

ğŸ§  Die wahre Ursache

Es gibt keine saubere Trennung zwischen:

Replit-spezifischer DB-Logik (Neon)

Server-spezifischer DB-Logik (node-postgres / pg)

Beides liegt im selben Branch / selben Codepfad.

Dadurch passiert Folgendes:

Server wird korrekt auf pg + drizzle-orm/node-postgres umgestellt

App lÃ¤uft stabil

Beim nÃ¤chsten git pull kommt Neon-Code zurÃ¼ck

Server crasht wieder

Das ist nicht tragbar fÃ¼r Produktion.

âœ… Wie wir es manuell gefixt haben (Beweis)

Auf dem Server mussten wir jedes Mal manuell:

Neon komplett entfernen aus:

server/storage-db.ts

server/routes.ts

Umstellen auf:

import { Pool } from "pg";
import { drizzle } from "drizzle-orm/node-postgres";


Neu builden

PM2 neu starten

Erst dann waren die Logs wieder sauber:

[express] serving on port 5000
(no errors)

ğŸŸ¢ Die notwendige dauerhafte LÃ¶sung (sehr wichtig)

Eine dieser LÃ¶sungen MUSS umgesetzt werden, sonst ist der Workflow dauerhaft kaputt:

Option A (empfohlen): Environment-basierte DB-Auswahl

Zentral in einer Datei (z. B. server/db.ts):

if (process.env.RUNTIME_ENV === "server") {
  // pg + drizzle-orm/node-postgres
} else {
  // neon + drizzle-orm/neon-http
}


Replit setzt: RUNTIME_ENV=replit

Server setzt: RUNTIME_ENV=server

Kein manuelles Editieren mehr

git pull ist sicher

Option B: Branch-Trennung

main â†’ Server (pg)

replit â†’ Neon

Replit entwickelt auf replit

Server pulled nur main

Option C (schlechteste, aber mÃ¶glich):

Neon-Code komplett entfernen

Auch Replit nutzt dann pg oder Neon nur noch Ã¼ber ENV-Abstraktion

â— Warum das wichtig ist

Aktuell gilt:

âŒ Jeder git pull kann die Produktion crashen

âŒ Manuelle Server-Hacks sind nÃ¶tig

âŒ OneSignal-Fehler sind Folgefehler, nicht Ursache

Das ist kein Benutzerfehler, sondern ein Architekturproblem im Repo.

âœ… Erwartetes Ergebnis nach Fix

git pull auf dem Server ist immer sicher

Keine Neon-Imports mehr auf Server

OneSignal funktioniert sofort (ENV war korrekt)

Kein manueller Code-Fix mehr nÃ¶tig

Bitte gebt Bescheid, welche Option ihr umsetzt.
So wie es jetzt ist, ist das Setup nicht produktionsfÃ¤hig.

Danke.

ğŸ§¾ Zusatz fÃ¼r dich, Sir (kurz & klar):